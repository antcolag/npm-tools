<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Tests</title>
	<script type="module" async src="./reactive.js"></script>
	<script type="module" async src="./observe.js"></script>
	<script type="module" async src="./tools.js"></script>
	<script type="module" async src="./test.js"></script>
	<script type="module" async src="./utils.js"></script>
	<script type="module" async src="./readable.js"></script>
	<script type="module" async src="./dom.js"></script>
	<script type="module" defer>
		import Test from "./test.js";
		import * as dom from "./dom.js";
		import readable from "./readable.js";
		import reactive from "./reactive.js";
		import {lisperato} from "./tools.js";
		import {
			apply,
			pipe,
			yes
		} from "./utils.js";
		import {
			croak,
			ASSERT,
			ASSERT_T,
			ASSERT_F,
		} from "./debug.js";

		new Test("tests shuld work", async function (arg) {
			var tests = new Test(
				"reactive and events shuld work",
				() => {
					var r = new reactive()
					r.bindable('foo')
					r.bindable('bar');
					var o = {}
					r.bind('foo', o)
					r.bind('bar', o)
					r.bind('foo', (x) => document.body.appendChild(dom.emmet `p{updating foo ${x}}`))
					r.bind('bar', (x) => document.body.appendChild(dom.emmet `p{updating bar ${x}}`))

					Object.assign(r, {foo:1,bar:2})
					return ASSERT_T(o.foo == r.foo && o.bar == r.bar)
				}
			)
			tests.bind("result", this, "reactiveResult")
			tests.on(
				"PASSED FAILED complete",
				ASSERT.bind(null, this.reactiveResult, tests.result)
			)
			await tests.run(true)

			await new Test(
				"failing tests shuld work",
				croak
			).die(true)

			await new Test(
				"shuld fail if description is not a String",
				() => new Test(-1).run()
			).die(true)

			readable.call(console)
			var i = 0;
			var timer = setInterval(()=>{
				console.log(`...${++i}`)
			}, 100)
			await new Test(
				"readable shuld work (.2 sec timer)",
				pipe
			).run(await console.read(200))
			;
			clearInterval(timer)
			;

			timer = setInterval(()=>{
				console.log(`...${++i}`)
			}, 100)

			var timer2 = setInterval(()=>{
				console.broadcast('foo', 'bar')
			}, 200)

			await new Test(
				"readable shuld work (no timer)",
				pipe
			).run(await console.read())


			clearInterval(timer)

			await new Test(
				"emmet shuld work",
				() => {
				document.body.appendChild(dom.emmet `a#ciao[bella="ola"]>
					bella.pe#tutti+#e+.pure*2>
						(agli#altri+mhu#ah.ua[sdfd="dsf$$"]+ha{$$$@-5})*3
					^^ ^^ ^
					ale+section>
						div>
							pre{emmet generated}^
							${document.querySelector('h1')}+p{with fun}+ul>
							.azz*3`
				)
				document.body.appendChild(dom.emmet `div$$.c-\${$$$@3chiaro?$$@-8!!!}*3`)

				return ASSERT_T(document.querySelector('agli#altri'))
			}).run()

			const myTitle3 = document.createElement('h2')
			document.body.appendChild(dom.html `
				<article>
					${myTitle3}
				</article>
			`)
			myTitle3.innerHTML = 'hello world'
			const myTitle = document.createElement('h2')
			const myTitle2 = document.createElement('h2')
			document.body.appendChild(
				dom.emmet `article>${myTitle2}.title>{\\\\\\} } + span{hello ${567}} ^ ${myTitle}>{weeee}`
			)
			myTitle2.innerHTML += 'emmet!'

			return arg
		}).run(true)

		window.dom = dom
	</script>
</head>
<body>
	<h1>Tests</h1>
	<p>open the console</p>
</body>
</html>